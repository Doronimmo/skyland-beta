name: Multi-Platform Build

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            artifact-name: skyland-linux
          - os: macos-latest
            artifact-name: skyland-mac
          - os: windows-2019
            artifact-name: skyland-windows

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # --- LINUX SETUP ---
    - name: Install Dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libsdl2-dev libsdl2-image-dev cmake ccache

    # --- MACOS SETUP ---
    # Your script expects frameworks in /Library/Frameworks
    - name: Install Frameworks (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install homebrew/cask/sdl2 homebrew/cask/sdl2_image
        # Note: If brew cask fails, we manually symlink or copy to /Library/Frameworks
        # to match your build system's hardcoded expectations.

    # --- WINDOWS SETUP ---
    # Your CMake expects SDL at the top level of C:\
    - name: Install SDL (Windows)
      if: runner.os == 'Windows'
      shell: powershell
      run: |
        file_path: "SDL2-devel-2.0.22-VC.zip"
        # We download and extract specifically to C:\SDL2 to match your script
        Invoke-WebRequest -Uri "https://www.libsdl.org/release/SDL2-devel-2.0.22-VC.zip" -OutFile "SDL2.zip"
        Expand-Archive -Path "SDL2.zip" -DestinationPath "C:\"
        Move-Item "C:\SDL2-2.0.22" "C:\SDL2"
        
        Invoke-WebRequest -Uri "https://www.libsdl.org/projects/SDL_image/release/SDL2_image-devel-2.0.5-VC.zip" -OutFile "SDL2_img.zip"
        Expand-Archive -Path "SDL2_img.zip" -DestinationPath "C:\"
        Move-Item "C:\SDL2_image-2.0.5" "C:\SDL2_image"

    # --- BUILD STEP ---
    - name: Configure and Build
      shell: bash
      run: |
        mkdir build && cd build
        if [ "${{ runner.os }}" == "Windows" ]; then
          # Match your manual command: Visual Studio 16 2019, x64, GBA OFF
          cmake .. -G "Visual Studio 16 2019" -A x64 -DGAMEBOY_ADVANCE=OFF
          cmake --build . --config Release
        elif [ "${{ runner.os }}" == "macOS" ]; then
          ../set-desktop-toolchain.sh
          make
        else
          # Linux specific (using your original logic)
          cmake .. -DGAMEBOY_ADVANCE=OFF
          make -j$(nproc)
        fi

    # --- POST-BUILD (Windows DLL Copy) ---
    - name: Prepare Windows Release
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        Copy-Item "C:\SDL2\lib\x64\*.dll" -Destination "build\Release\"
        Copy-Item "C:\SDL2_image\lib\x64\*.dll" -Destination "build\Release\"

    - name: Upload Build
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: |
          build/Release/
          build/Skyland.app
          build/skyland/bin/
